---
apiVersion: concourse.govsvc.uk/v1beta1
kind: Pipeline
metadata:
  labels:
    controller-tools.k8s.io: "1.0"
  name: deploy
spec:
  exposed: true
  config:

    github_source: &github_source
      uri: https://github.com/alphagov/verify-proxy-node.git
      organization: alphagov
      owner: alphagov
      repository: verify-proxy-node
      github_api_token: ((github.api-token))
      access_token: ((github.api-token))
      approvers: ((trusted-developers.github-accounts))
      required_approval_count: 2

    task_toolbox: &task_toolbox
      type: docker-image
      source:
        repository: ((concourse.task-toolbox-image))
        tag: ((concourse.task-toolbox-tag))

    resource_types:

    - name: github
      type: registry-image
      source:
        repository: ((concourse.github-resource-image))
        tag: ((concourse.github-resource-tag))

    resources:

    - name: release
      type: github-release
      icon: tag
      source:
        <<: *github_source
        tag_filter: ^v1\.\d+$

    - name: nightly
      type: time
      icon: update
      source:
        interval: 1h
        start: 3:00 AM
        stop: 4:00 AM

    jobs:

    - name: deploy-nl-production
      serial: true
      plan:

      - get: release
        trigger: true

      - get: nightly
        trigger: true

      - task: render-manifests
        config:
          platform: linux
          image_resource: *task_toolbox
          inputs:
          - name: release
          outputs:
          - name: manifests
          params:
            CLUSTER_NAME: ((cluster.name))
            CLUSTER_DOMAIN: ((cluster.domain))
            CLUSTER_PUBLIC_KEY: ((artefact-signing-key.publicKey))
            RELEASE_NAMESPACE: ((namespace-deployer.namespace))
            RELEASE_NAME: nl
            HUB_FQDN: www.signin.service.gov.uk
            ERROR_PAGE_URL: https://www.signin.service.gov.uk/proxy-node-error
            CONNECTOR_NODE_NATIONALITY_CODE: NL
            CONNECTOR_ENTITY_ID: https://eidas.minez.nl/EidasNodeC/ConnectorMetadata
            CONNECTOR_METADATA_FQDN: eidas.minez.nl
            CONNECTOR_METADATA_PATH: /EidasNodeC/ConnectorMetadata
            CONNECTOR_METADATA_SIGNING_TRUSTSTORE_BASE64: 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
            CLOUDHSM_IP: ((cluster.cloudHsmIp))
          run:
            path: /bin/bash
            args:
            - -euc
            - |
              echo "preparing keyring..."
              echo "${CLUSTER_PUBLIC_KEY}" > key
              gpg --import key
              gpg --export > ~/.gnupg/pubring.gpg
              echo "verifying package"
              helm verify ./release/*.tgz
              echo "rendering chart with release name '${RELEASE_NAME}' and namespace '${RELEASE_NAMESPACE}'..."
              helm template \
                --name "${RELEASE_NAME}" \
                --namespace "${RELEASE_NAMESPACE}" \
                --set "global.cluster.name=${CLUSTER_NAME}" \
                --set "global.cluster.domain=${CLUSTER_DOMAIN}" \
                --set "global.cloudHsm.ip=${CLOUDHSM_IP}" \
                --set "hubFqdn=${HUB_FQDN}" \
                --set "gateway.errorPageURL=${ERROR_PAGE_URL}" \
                --set "connector.entityID=${CONNECTOR_ENTITY_ID}" \
                --set "connector.metadata.fqdn=${CONNECTOR_METADATA_FQDN}" \
                --set "connector.metadata.path=${CONNECTOR_METADATA_PATH}" \
                --set "connector.metadataSigningTruststoreBase64=${CONNECTOR_METADATA_SIGNING_TRUSTSTORE_BASE64}" \
                --set "translator.connectorNodeNationalityCode=${CONNECTOR_NODE_NATIONALITY_CODE}" \
                --output-dir "./manifests/" \
                ./release/*.tgz

      - task: deploy-manifests
        timeout: 10m
        config:
          platform: linux
          image_resource: *task_toolbox
          inputs:
          - name: manifests
          params:
            KUBERNETES_SERVICE_ACCOUNT: ((namespace-deployer))
            KUBERNETES_TOKEN: ((namespace-deployer.token))
            KUBERNETES_API: kubernetes.default.svc
            RELEASE_NAMESPACE: ((namespace-deployer.namespace))
            RELEASE_NAME: nl
            APP_NAME: proxy-node
          run:
            path: /bin/bash
            args:
            - -euc
            - |
              echo "configuring kubectl"
              echo "${KUBERNETES_SERVICE_ACCOUNT}" | jq -r .["ca.crt"] > ca.crt
              kubectl config set-cluster self --server=https://kubernetes.default --certificate-authority=ca.crt
              kubectl config set-credentials deployer --token "${KUBERNETES_TOKEN}"
              kubectl config set-context deployer --user deployer --cluster self
              kubectl config use-context deployer

              echo "applying chart to ${RELEASE_NAMESPACE} namespace..."
              kapp deploy \
                -y \
                --namespace "${RELEASE_NAMESPACE}" \
                --allow-ns "${RELEASE_NAMESPACE}" \
                --app "${RELEASE_NAME}-${APP_NAME}" \
                --diff-changes \
                -f ./manifests/

    - name: deploy-se-production
      serial: true
      plan:

      - get: release
        trigger: true

      - get: nightly
        trigger: true

      - task: render-manifests
        config:
          platform: linux
          image_resource: *task_toolbox
          inputs:
          - name: release
          outputs:
          - name: manifests
          params:
            CLUSTER_NAME: ((cluster.name))
            CLUSTER_DOMAIN: ((cluster.domain))
            CLUSTER_PUBLIC_KEY: ((artefact-signing-key.publicKey))
            RELEASE_NAMESPACE: ((namespace-deployer.namespace))
            RELEASE_NAME: se
            HUB_FQDN: www.signin.service.gov.uk
            ERROR_PAGE_URL: https://www.signin.service.gov.uk/proxy-node-error
            CONNECTOR_NODE_NATIONALITY_CODE: SE
            CONNECTOR_ENTITY_ID: https://connector.eidas.swedenconnect.se/idp/metadata/sp
            CONNECTOR_METADATA_FQDN: connector.eidas.swedenconnect.se
            CONNECTOR_METADATA_PATH: /idp/metadata/sp
            CONNECTOR_METADATA_SIGNING_TRUSTSTORE_BASE64: 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
            CLOUDHSM_IP: ((cluster.cloudHsmIp))
          run:
            path: /bin/bash
            args:
            - -euc
            - |
              echo "preparing keyring..."
              echo "${CLUSTER_PUBLIC_KEY}" > key
              gpg --import key
              gpg --export > ~/.gnupg/pubring.gpg
              echo "verifying package"
              helm verify ./release/*.tgz
              echo "rendering chart with release name '${RELEASE_NAME}' and namespace '${RELEASE_NAMESPACE}'..."
              helm template \
                --name "${RELEASE_NAME}" \
                --namespace "${RELEASE_NAMESPACE}" \
                --set "global.cluster.name=${CLUSTER_NAME}" \
                --set "global.cluster.domain=${CLUSTER_DOMAIN}" \
                --set "global.cloudHsm.ip=${CLOUDHSM_IP}" \
                --set "hubFqdn=${HUB_FQDN}" \
                --set "gateway.errorPageURL=${ERROR_PAGE_URL}" \
                --set "connector.entityID=${CONNECTOR_ENTITY_ID}" \
                --set "connector.metadata.fqdn=${CONNECTOR_METADATA_FQDN}" \
                --set "connector.metadata.path=${CONNECTOR_METADATA_PATH}" \
                --set "connector.metadataSigningTruststoreBase64=${CONNECTOR_METADATA_SIGNING_TRUSTSTORE_BASE64}" \
                --set "translator.connectorNodeNationalityCode=${CONNECTOR_NODE_NATIONALITY_CODE}" \
                --output-dir "./manifests/" \
                ./release/*.tgz

      - task: deploy-manifests
        timeout: 10m
        config:
          platform: linux
          image_resource: *task_toolbox
          inputs:
          - name: manifests
          params:
            KUBERNETES_SERVICE_ACCOUNT: ((namespace-deployer))
            KUBERNETES_TOKEN: ((namespace-deployer.token))
            KUBERNETES_API: kubernetes.default.svc
            RELEASE_NAMESPACE: ((namespace-deployer.namespace))
            RELEASE_NAME: se
            APP_NAME: proxy-node
          run:
            path: /bin/bash
            args:
            - -euc
            - |
              echo "configuring kubectl"
              echo "${KUBERNETES_SERVICE_ACCOUNT}" | jq -r .["ca.crt"] > ca.crt
              kubectl config set-cluster self --server=https://kubernetes.default --certificate-authority=ca.crt
              kubectl config set-credentials deployer --token "${KUBERNETES_TOKEN}"
              kubectl config set-context deployer --user deployer --cluster self
              kubectl config use-context deployer

              echo "applying chart to ${RELEASE_NAMESPACE} namespace..."
              kapp deploy \
                -y \
                --namespace "${RELEASE_NAMESPACE}" \
                --allow-ns "${RELEASE_NAMESPACE}" \
                --app "${RELEASE_NAME}-${APP_NAME}" \
                --diff-changes \
                -f ./manifests/

    - name: deploy-cz-production
      serial: true
      plan:

      - get: release
        trigger: true

      - get: nightly
        trigger: true

      - task: render-manifests
        config:
          platform: linux
          image_resource: *task_toolbox
          inputs:
          - name: release
          outputs:
          - name: manifests
          params:
            CLUSTER_NAME: ((cluster.name))
            CLUSTER_DOMAIN: ((cluster.domain))
            CLUSTER_PUBLIC_KEY: ((artefact-signing-key.publicKey))
            RELEASE_NAMESPACE: ((namespace-deployer.namespace))
            RELEASE_NAME: cz
            HUB_FQDN: www.signin.service.gov.uk
            ERROR_PAGE_URL: https://www.signin.service.gov.uk/proxy-node-error
            CONNECTOR_NODE_NATIONALITY_CODE: CZ
            CONNECTOR_ENTITY_ID: https://conn.eidasnode.cz/EidasNode/ConnectorMetadata
            CONNECTOR_METADATA_FQDN: conn.eidasnode.cz
            CONNECTOR_METADATA_PATH: /EidasNode/ConnectorMetadata
            CONNECTOR_METADATA_SIGNING_TRUSTSTORE_BASE64: MIIDfgIBAzCCAzcGCSqGSIb3DQEHAaCCAygEggMkMIIDIDCCAxwGCSqGSIb3DQEHBqCCAw0wggMJAgEAMIIDAgYJKoZIhvcNAQcBMCkGCiqGSIb3DQEMAQYwGwQUqBnJ9JaywtRr1f+gilP/uSuTb7ICAwDDUICCAsjuyYipUJ9wERod2H+k54em3CVN1sO4wVP04zgvMA6JNbkXn20T6GcbvtJAsidUBXJW/PyxVWigcXJVWTRleSfFJQljfJy5hVoV/y9Mr7fa+/wi992n8xhIbU3gIUioi1fzdYTNHJAxQYsGZN63+/OouwTBTZV8QNf3biI4JRcLVmIMYTzLt7++wQRHt/l1b0Z1mRUORlsnYRVvA8GelYpAQGTpIIMC74u834qSr3ZKIAdapVDSTL9+vh+Zb9W7nVFGqCmYT+S7y+9DlV8PLovTR5xvNo5jPBr/hxrkt/+IEqRw8sWl3ENc6cIPPKIrhvZWGbMrC/WHWkPNS/vDZBEM6BnfjgoA+pD8bOj/hJNjCw5JZOSTda238A/R9/4U0TwCl5tLwcUNae1MNE/hknZDZtmLLa3S/7sgbRVzVupEECI3qncw5/gGJIbI0q7fO7J9asKnD9teoGPjzY9MORTnxfjs8y1cdHYMGjdDGTOWMAU+VxKu5M8bUym+KglO26MH15i5OLhClIf/iKHIOQeHCYX+14QcOxTiucdVqkyEQaUbXHSZpu5mS0rYX7Voqlqt03v3Q4g6V6CsiufXVULQxPrtc95Lifhcb0N+T4bJa3g+YOq3pVYNK5yxOlCjgfnLXZpfBgGVWQ4Jgr85P3MPuuXljeuqFS8w1q/2fEqnCN1azvjSE9g7wbUHTvbBsssNePfovypikbMj4sOxZJXfqjl+J5hbc3Wt7DF3hmsLeF5RSiDtGgQ0Rptxpljczct7biZ4gEHJIVczSsjaxSqnFwFLfYAX+Afs9VynqtvdtFCERF0C8u1kLFCIUhsanoVfRqVRbRMVGd64Gg2TdTRVoL806oCR3B401zSwgVCkmupgIgxduQYvmM+j1k0jKdhZi5wnwExIRUrf2lwiY1rDAyGbRTzeoYL05jxyLB1z90a2Z5OaaZxGMD4wITAJBgUrDgMCGgUABBQVdEBb70xXdXyGgpCIbHJ70XWHsAQULRH0QjEEx/RrcyErP9YmH3NUUUMCAwGGoA==
            CLOUDHSM_IP: ((cluster.cloudHsmIp))
          run:
            path: /bin/bash
            args:
            - -euc
            - |
              echo "preparing keyring..."
              echo "${CLUSTER_PUBLIC_KEY}" > key
              gpg --import key
              gpg --export > ~/.gnupg/pubring.gpg
              echo "verifying package"
              helm verify ./release/*.tgz
              echo "rendering chart with release name '${RELEASE_NAME}' and namespace '${RELEASE_NAMESPACE}'..."
              helm template \
                --name "${RELEASE_NAME}" \
                --namespace "${RELEASE_NAMESPACE}" \
                --set "global.cluster.name=${CLUSTER_NAME}" \
                --set "global.cluster.domain=${CLUSTER_DOMAIN}" \
                --set "global.cloudHsm.ip=${CLOUDHSM_IP}" \
                --set "hubFqdn=${HUB_FQDN}" \
                --set "gateway.errorPageURL=${ERROR_PAGE_URL}" \
                --set "connector.entityID=${CONNECTOR_ENTITY_ID}" \
                --set "connector.metadata.fqdn=${CONNECTOR_METADATA_FQDN}" \
                --set "connector.metadata.path=${CONNECTOR_METADATA_PATH}" \
                --set "connector.metadataSigningTruststoreBase64=${CONNECTOR_METADATA_SIGNING_TRUSTSTORE_BASE64}" \
                --set "translator.connectorNodeNationalityCode=${CONNECTOR_NODE_NATIONALITY_CODE}" \
                --output-dir "./manifests/" \
                ./release/*.tgz

      - task: deploy-manifests
        timeout: 10m
        config:
          platform: linux
          image_resource: *task_toolbox
          inputs:
          - name: manifests
          params:
            KUBERNETES_SERVICE_ACCOUNT: ((namespace-deployer))
            KUBERNETES_TOKEN: ((namespace-deployer.token))
            KUBERNETES_API: kubernetes.default.svc
            RELEASE_NAMESPACE: ((namespace-deployer.namespace))
            RELEASE_NAME: cz
            APP_NAME: proxy-node
          run:
            path: /bin/bash
            args:
            - -euc
            - |
              echo "configuring kubectl"
              echo "${KUBERNETES_SERVICE_ACCOUNT}" | jq -r .["ca.crt"] > ca.crt
              kubectl config set-cluster self --server=https://kubernetes.default --certificate-authority=ca.crt
              kubectl config set-credentials deployer --token "${KUBERNETES_TOKEN}"
              kubectl config set-context deployer --user deployer --cluster self
              kubectl config use-context deployer

              echo "applying chart to ${RELEASE_NAMESPACE} namespace..."
              kapp deploy \
                -y \
                --namespace "${RELEASE_NAMESPACE}" \
                --allow-ns "${RELEASE_NAMESPACE}" \
                --app "${RELEASE_NAME}-${APP_NAME}" \
                --diff-changes \
                -f ./manifests/

    - name: deploy-it-production
      serial: true
      plan:

      - get: release
        trigger: true

      - get: nightly
        trigger: true

      - task: render-manifests
        config:
          platform: linux
          image_resource: *task_toolbox
          inputs:
          - name: release
          outputs:
          - name: manifests
          params:
            CLUSTER_NAME: ((cluster.name))
            CLUSTER_DOMAIN: ((cluster.domain))
            CLUSTER_PUBLIC_KEY: ((artefact-signing-key.publicKey))
            RELEASE_NAMESPACE: ((namespace-deployer.namespace))
            RELEASE_NAME: it
            HUB_FQDN: www.signin.service.gov.uk
            ERROR_PAGE_URL: https://www.signin.service.gov.uk/proxy-node-error
            CONNECTOR_NODE_NATIONALITY_CODE: IT
            CONNECTOR_ENTITY_ID: https://connector.eid.gov.it/EidasNode/ConnectorMetadata
            CONNECTOR_METADATA_FQDN: connector.eid.gov.it
            CONNECTOR_METADATA_PATH: /EidasNode/ConnectorMetadata
            CONNECTOR_METADATA_SIGNING_TRUSTSTORE_BASE64: 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
            CLOUDHSM_IP: ((cluster.cloudHsmIp))
          run:
            path: /bin/bash
            args:
            - -euc
            - |
              echo "preparing keyring..."
              echo "${CLUSTER_PUBLIC_KEY}" > key
              gpg --import key
              gpg --export > ~/.gnupg/pubring.gpg
              echo "verifying package"
              helm verify ./release/*.tgz
              echo "rendering chart with release name '${RELEASE_NAME}' and namespace '${RELEASE_NAMESPACE}'..."
              helm template \
                --name "${RELEASE_NAME}" \
                --namespace "${RELEASE_NAMESPACE}" \
                --set "global.cluster.name=${CLUSTER_NAME}" \
                --set "global.cluster.domain=${CLUSTER_DOMAIN}" \
                --set "global.cloudHsm.ip=${CLOUDHSM_IP}" \
                --set "hubFqdn=${HUB_FQDN}" \
                --set "gateway.errorPageURL=${ERROR_PAGE_URL}" \
                --set "connector.entityID=${CONNECTOR_ENTITY_ID}" \
                --set "connector.metadata.fqdn=${CONNECTOR_METADATA_FQDN}" \
                --set "connector.metadata.path=${CONNECTOR_METADATA_PATH}" \
                --set "connector.metadataSigningTruststoreBase64=${CONNECTOR_METADATA_SIGNING_TRUSTSTORE_BASE64}" \
                --set "translator.connectorNodeNationalityCode=${CONNECTOR_NODE_NATIONALITY_CODE}" \
                --output-dir "./manifests/" \
                ./release/*.tgz

      - task: deploy-manifests
        timeout: 10m
        config:
          platform: linux
          image_resource: *task_toolbox
          inputs:
          - name: manifests
          params:
            KUBERNETES_SERVICE_ACCOUNT: ((namespace-deployer))
            KUBERNETES_TOKEN: ((namespace-deployer.token))
            KUBERNETES_API: kubernetes.default.svc
            RELEASE_NAMESPACE: ((namespace-deployer.namespace))
            RELEASE_NAME: it
            APP_NAME: proxy-node
          run:
            path: /bin/bash
            args:
            - -euc
            - |
              echo "configuring kubectl"
              echo "${KUBERNETES_SERVICE_ACCOUNT}" | jq -r .["ca.crt"] > ca.crt
              kubectl config set-cluster self --server=https://kubernetes.default --certificate-authority=ca.crt
              kubectl config set-credentials deployer --token "${KUBERNETES_TOKEN}"
              kubectl config set-context deployer --user deployer --cluster self
              kubectl config use-context deployer

              echo "applying chart to ${RELEASE_NAMESPACE} namespace..."
              kapp deploy \
                -y \
                --namespace "${RELEASE_NAMESPACE}" \
                --allow-ns "${RELEASE_NAMESPACE}" \
                --app "${RELEASE_NAME}-${APP_NAME}" \
                --diff-changes \
                -f ./manifests/

    - name: deploy-mt-production
      serial: true
      plan:

        - get: release
          trigger: true

        - get: nightly
          trigger: true

        - task: render-manifests
          config:
            platform: linux
            image_resource: *task_toolbox
            inputs:
              - name: release
            outputs:
              - name: manifests
            params:
              CLUSTER_NAME: ((cluster.name))
              CLUSTER_DOMAIN: ((cluster.domain))
              CLUSTER_PUBLIC_KEY: ((artefact-signing-key.publicKey))
              RELEASE_NAMESPACE: ((namespace-deployer.namespace))
              RELEASE_NAME: mt
              CONNECTOR_NODE_NATIONALITY_CODE: MT
              CONNECTOR_ENTITY_ID: https://mteidasnode.gov.mt/EidasNode/ConnectorMetadata
              CONNECTOR_METADATA_FQDN: mteidasnode.gov.mt
              CONNECTOR_METADATA_PATH: /EidasNode/ConnectorMetadata
              CONNECTOR_METADATA_SIGNING_TRUSTSTORE_BASE64: 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
              CLOUDHSM_IP: ((cluster.cloudHsmIp))
            run:
              path: /bin/bash
              args:
                - -euc
                - |
                  echo "preparing keyring..."
                  echo "${CLUSTER_PUBLIC_KEY}" > key
                  gpg --import key
                  gpg --export > ~/.gnupg/pubring.gpg
                  echo "verifying package"
                  helm verify ./release/*.tgz
                  echo "rendering chart with release name '${RELEASE_NAME}' and namespace '${RELEASE_NAMESPACE}'..."
                  helm template \
                    --name "${RELEASE_NAME}" \
                    --namespace "${RELEASE_NAMESPACE}" \
                    --set "global.cluster.name=${CLUSTER_NAME}" \
                    --set "global.cluster.domain=${CLUSTER_DOMAIN}" \
                    --set "global.cloudHsm.ip=${CLOUDHSM_IP}" \
                    --set "connector.entityID=${CONNECTOR_ENTITY_ID}" \
                    --set "connector.metadata.fqdn=${CONNECTOR_METADATA_FQDN}" \
                    --set "connector.metadata.path=${CONNECTOR_METADATA_PATH}" \
                    --set "connector.metadataSigningTruststoreBase64=${CONNECTOR_METADATA_SIGNING_TRUSTSTORE_BASE64}" \
                    --set "translator.connectorNodeNationalityCode=${CONNECTOR_NODE_NATIONALITY_CODE}" \
                    --output-dir "./manifests/" \
                    ./release/*.tgz

        - task: deploy-manifests
          timeout: 10m
          config:
            platform: linux
            image_resource: *task_toolbox
            inputs:
              - name: manifests
            params:
              KUBERNETES_SERVICE_ACCOUNT: ((namespace-deployer))
              KUBERNETES_TOKEN: ((namespace-deployer.token))
              KUBERNETES_API: kubernetes.default.svc
              RELEASE_NAMESPACE: ((namespace-deployer.namespace))
              RELEASE_NAME: mt
              APP_NAME: proxy-node
            run:
              path: /bin/bash
              args:
                - -euc
                - |
                  echo "configuring kubectl"
                  echo "${KUBERNETES_SERVICE_ACCOUNT}" | jq -r .["ca.crt"] > ca.crt
                  kubectl config set-cluster self --server=https://kubernetes.default --certificate-authority=ca.crt
                  kubectl config set-credentials deployer --token "${KUBERNETES_TOKEN}"
                  kubectl config set-context deployer --user deployer --cluster self
                  kubectl config use-context deployer

                  echo "applying chart to ${RELEASE_NAMESPACE} namespace..."
                  kapp deploy \
                    -y \
                    --namespace "${RELEASE_NAMESPACE}" \
                    --allow-ns "${RELEASE_NAMESPACE}" \
                    --app "${RELEASE_NAME}-${APP_NAME}" \
                    --diff-changes \
                    -f ./manifests/
